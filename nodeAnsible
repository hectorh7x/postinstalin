#!/bin/bash

# ---------------------------
# ðŸ› ï¸ Variables de configuraciÃ³n
# ---------------------------
USUARIO_ANSIBLE="ansible"

# ---------------------------
# ðŸ”„ Actualizar el sistema operativo
# ---------------------------
echo "ðŸ”„ Actualizando el sistema..."
sudo dnf update -y

# ---------------------------
# ðŸ“¦ Instalar paquetes necesarios
# ---------------------------
echo "ðŸ“¦ Instalando python3, SSH server y firewalld..."
sudo dnf install -y python3 openssh-server firewalld sudo

# ---------------------------
# ðŸš€ Habilitar y configurar servicios bÃ¡sicos
# ---------------------------
echo "ðŸš€ Habilitando servicios SSH y Firewall..."
sudo systemctl enable --now sshd
sudo systemctl enable --now firewalld
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --reload

# ---------------------------
# ðŸ‘¤ Crear y preparar usuario para Ansible
# ---------------------------
if id "${USUARIO_ANSIBLE}" &>/dev/null; then
    echo "âœ… Usuario '${USUARIO_ANSIBLE}' ya existe."
else
    echo "ðŸ‘¤ Creando usuario '${USUARIO_ANSIBLE}'..."
    sudo adduser "${USUARIO_ANSIBLE}"
    sudo usermod -aG wheel "${USUARIO_ANSIBLE}"
fi

# ---------------------------
# ðŸ”’ Endurecer configuraciÃ³n SSH
# ---------------------------
echo "ðŸ”’ Endureciendo configuraciÃ³n SSH..."
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak

sudo sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
sudo sed -i 's/^#*PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
sudo sed -i 's/^#*PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config
sudo sed -i 's/^#*ChallengeResponseAuthentication.*/ChallengeResponseAuthentication no/' /etc/ssh/sshd_config
sudo sed -i 's/^#*UseDNS.*/UseDNS no/' /etc/ssh/sshd_config
sudo sed -i 's/^#*MaxAuthTries.*/MaxAuthTries 3/' /etc/ssh/sshd_config

# Asegurar que solo el usuario ansible puede conectarse por SSH
if ! grep -q "^AllowUsers ${USUARIO_ANSIBLE}" /etc/ssh/sshd_config; then
    echo "AllowUsers ${USUARIO_ANSIBLE}" | sudo tee -a /etc/ssh/sshd_config
fi

sudo systemctl restart sshd

# ---------------------------
# ðŸ§© Configurar sudo sin contraseÃ±a para Ansible
# ---------------------------
echo "ðŸ§© Configurando sudo sin contraseÃ±a para '${USUARIO_ANSIBLE}'..."
if ! sudo grep -q "^${USUARIO_ANSIBLE} ALL=(ALL) NOPASSWD: ALL" /etc/sudoers; then
    echo "${USUARIO_ANSIBLE} ALL=(ALL) NOPASSWD: ALL" | sudo EDITOR='tee -a' visudo
fi

# ---------------------------
# ðŸ“‹ Mensaje final para completar configuraciÃ³n
# ---------------------------
echo
echo "âœ… El nodo ha sido alistado correctamente para ser gestionado por Ansible."
echo
echo "âš¡ IMPORTANTE: Desde el servidor controlador ahora debes ejecutar:"
echo "ssh-copy-id -i /home/ansible/.ssh/id_rsa.pub ${USUARIO_ANSIBLE}@IP_DEL_NODO"
echo
echo "ðŸ’¬ Reemplaza 'IP_DEL_NODO' por la IP real de este nodo."
echo

