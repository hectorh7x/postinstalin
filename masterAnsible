#!/bin/bash

# --------------------------------------
# üõ†Ô∏è VARIABLES (ajusta si deseas)
# --------------------------------------
USUARIO_ANSIBLE="ansible"
SSH_KEY_COMMENT="controlador-ansible"
SSH_KEY_FILE="/home/${USUARIO_ANSIBLE}/.ssh/id_rsa"

# --------------------------------------
# üìã ACTUALIZAR EL SISTEMA
# --------------------------------------
echo "üîÑ Actualizando sistema..."
sudo dnf update -y

# --------------------------------------
# üìã INSTALAR PAQUETES NECESARIOS
# --------------------------------------
echo "üì¶ Instalando paquetes base..."
sudo dnf install -y epel-release
sudo dnf install -y python3 python3-pip openssh-server sudo firewalld git

# Instalar Ansible desde EPEL
echo "üì¶ Instalando Ansible..."
sudo dnf install -y ansible

# --------------------------------------
# üìã CONFIGURAR FIREWALL
# --------------------------------------
echo "üß± Configurando firewall..."
sudo systemctl enable --now firewalld
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --reload

# --------------------------------------
# üìã CREAR USUARIO DEDICADO PARA ANSIBLE
# --------------------------------------
if id "${USUARIO_ANSIBLE}" &>/dev/null; then
    echo "‚úÖ Usuario ${USUARIO_ANSIBLE} ya existe."
else
    echo "üë§ Creando usuario ${USUARIO_ANSIBLE}..."
    sudo adduser "${USUARIO_ANSIBLE}"
    sudo usermod -aG wheel "${USUARIO_ANSIBLE}"
fi

# --------------------------------------
# üìã ENDURECER SSH
# --------------------------------------
echo "üîí Endureciendo SSH..."
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak

sudo sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
sudo sed -i 's/^#*PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
sudo sed -i 's/^#*PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config
sudo sed -i 's/^#*ChallengeResponseAuthentication.*/ChallengeResponseAuthentication no/' /etc/ssh/sshd_config
sudo sed -i 's/^#*UseDNS.*/UseDNS no/' /etc/ssh/sshd_config
sudo sed -i 's/^#*MaxAuthTries.*/MaxAuthTries 3/' /etc/ssh/sshd_config

# Restringir SSH solo al usuario ansible
if ! grep -q "^AllowUsers ${USUARIO_ANSIBLE}" /etc/ssh/sshd_config; then
    echo "AllowUsers ${USUARIO_ANSIBLE}" | sudo tee -a /etc/ssh/sshd_config
fi

sudo systemctl restart sshd

# --------------------------------------
# üìã CONFIGURAR SUDO SIN CONTRASE√ëA PARA ANSIBLE
# --------------------------------------
echo "üß© Configurando sudo sin contrase√±a para ${USUARIO_ANSIBLE}..."
if ! sudo grep -q "^${USUARIO_ANSIBLE} ALL=(ALL) NOPASSWD: ALL" /etc/sudoers; then
    echo "${USUARIO_ANSIBLE} ALL=(ALL) NOPASSWD: ALL" | sudo EDITOR='tee -a' visudo
fi

# --------------------------------------
# üìã CREAR CLAVES SSH DEL USUARIO ANSIBLE
# --------------------------------------
echo "üîë Creando par de claves SSH para ${USUARIO_ANSIBLE}..."
sudo -u "${USUARIO_ANSIBLE}" mkdir -p "/home/${USUARIO_ANSIBLE}/.ssh"
sudo -u "${USUARIO_ANSIBLE}" chmod 700 "/home/${USUARIO_ANSIBLE}/.ssh"

if [ ! -f "${SSH_KEY_FILE}" ]; then
    sudo -u "${USUARIO_ANSIBLE}" ssh-keygen -t rsa -b 4096 -f "${SSH_KEY_FILE}" -N "" -C "${SSH_KEY_COMMENT}"
    echo "‚úÖ Llave SSH creada en ${SSH_KEY_FILE}"
else
    echo "‚úÖ Llave SSH ya existe en ${SSH_KEY_FILE}"
fi

# --------------------------------------
# üìã CONFIGURACI√ìN FINAL
# --------------------------------------
echo "üõ°Ô∏è Configuraci√≥n de controlador Ansible completada de manera segura."
echo "‚û°Ô∏è Ahora puedes usar la clave p√∫blica: ${SSH_KEY_FILE}.pub para agregar nodos."
